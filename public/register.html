<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Register</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&family=Rubik&display=swap" rel="stylesheet">

    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- jQuery + jQuery Validate -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>

    <style>
        body {
            font-family: 'Rubik', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
        }

        h2 {
            font-family: 'Orbitron', sans-serif;
        }

        input[type="email"],
        input[type="password"] {
            background-color: #1a1a1a;
            color: #ffffff;
            border: 1px solid #444;
        }

        input:focus {
            border-color: #1E90FF;
            box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.4);
        }

        button {
            font-family: 'Orbitron', sans-serif;
        }

        .form-card {
            background-color: #111827;
            border: 1px solid #1E90FF;
            box-shadow: 0 0 20px rgba(30, 144, 255, 0.2);
        }

        a {
            transition: color 0.3s ease;
        }

        a:hover {
            color: #39FF14;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4">
    <div class="form-card p-8 rounded-xl w-full max-w-md text-white">
        <h2 class="text-3xl font-bold text-center mb-6 text-[#65aaf7]">Register</h2>
        <form id="registerForm">
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium mb-2">Email</label>
                <input type="email" id="email" name="email"
                       class="w-full px-3 py-2 rounded-md focus:outline-none transition duration-200">
            </div>
            
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium mb-2">Password</label>
                <input type="password" id="password" name="password"
                       class="w-full px-3 py-2 rounded-md focus:outline-none transition duration-200">
            </div>

            <div class="mb-4">
                <label for="confirmPassword" class="block text-sm font-medium mb-2">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword"
                       class="w-full px-3 py-2 rounded-md focus:outline-none transition duration-200">
            </div>
            
            <button type="submit" id="registerBtn"
                    class="w-full bg-[#1E90FF] hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                Register
            </button>
        </form>

        <div class="mt-3">
            <button onclick="window.location.href='index.html'"
                    class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                Back to Home
            </button>
        </div>

        <p class="text-center text-sm text-gray-400 mt-4">
            Already have an account?
            <a href="index.html" onclick="localStorage.setItem('showLoginModal', 'true')" class="text-[#1E90FF] hover:underline">
                Login here
            </a>
        </p>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:4000/api';
        let emailCheckTimeout = null;

        $(document).ready(() => {
            $.validator.addMethod("emailAvailable", function(value, element) {
                if (!value || !$.validator.methods.email.call(this, value, element)) {
                    return true;
                }

                let isAvailable = true;

                $.ajax({
                    url: `${API_BASE_URL}/users/check-email?email=${encodeURIComponent(value)}`,
                    method: 'GET',
                    async: false,
                    success: (response) => {
                        if (response.success) {
                            isAvailable = response.available;
                        }
                    },
                    error: () => {
                        isAvailable = true;
                    }
                });

                return isAvailable;
            }, "Email is already registered");

            $('#registerForm').validate({
                rules: {
                    email: {
                        required: true,
                        email: true,
                        emailAvailable: true
                    },
                    password: {
                        required: true,
                        minlength: 6
                    },
                    confirmPassword: {
                        required: true,
                        equalTo: "#password"
                    }
                },
                messages: {
                    email: {
                        required: "Please enter your email address",
                        email: "Please enter a valid email address",
                        emailAvailable: "Email is already registered"
                    },
                    password: {
                        required: "Please enter a password",
                        minlength: "Password must be at least 6 characters long"
                    },
                    confirmPassword: {
                        required: "Please confirm your password",
                        equalTo: "Passwords do not match"
                    }
                },
                errorElement: "div",
                errorClass: "text-red-400 text-xs mt-1",
                highlight: (element) => {
                    $(element).addClass("border-red-500");
                },
                unhighlight: (element) => {
                    $(element).removeClass("border-red-500");
                },
                submitHandler: function(form) {
                    const formData = new FormData(form);
                    const registerData = {
                        email: formData.get("email"),
                        password: formData.get("password"),
                    };
                    performRegistration(registerData);
                }
            });

            $('#email').on('input', function() {
                const email = $(this).val().trim();

                if (emailCheckTimeout) {
                    clearTimeout(emailCheckTimeout);
                }

                if (email && $.validator.methods.email.call($.validator.prototype, email, this)) {
                    emailCheckTimeout = setTimeout(() => {
                        checkEmailAvailability(email);
                    }, 500);
                }
            });
        });

        function checkEmailAvailability(email) {
            $.ajax({
                url: `${API_BASE_URL}/users/check-email?email=${encodeURIComponent(email)}`,
                method: 'GET',
                success: (response) => {
                    if (response.success) {
                        const emailField = $('#email');
                        const existingError = emailField.next('.email-availability-error');

                        if (!response.available) {
                            if (existingError.length === 0) {
                                emailField.addClass('border-red-500');
                                emailField.after('<div class="email-availability-error text-red-400 text-xs mt-1">Email is already registered</div>');
                            }
                        } else {
                            existingError.remove();
                            emailField.removeClass('border-red-500');
                        }
                    }
                },
                error: (xhr) => {
                    console.error('Error checking email availability:', xhr);
                }
            });
        }

        function performRegistration(registerData) {
            $('#registerBtn').prop('disabled', true).text('Registering...');

            $.ajax({
                url: `${API_BASE_URL}/users/register`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(registerData),
                success: (response) => {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Registration Successful!',
                            text: 'Your account has been created successfully. You can now login.',
                            confirmButtonText: 'Go to Login'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                localStorage.setItem('showLoginModal', 'true');
                                window.location.href = 'index.html';
                            }
                        });
                    }
                },
                error: (xhr) => {
                    const errorResponse = xhr.responseJSON;
                    const errorMessage = errorResponse?.message || 'Registration failed';

                    if (errorMessage.includes('Email already exists')) {
                        const emailField = $('#email');
                        emailField.addClass('border-red-500');

                        emailField.next('.error').remove();
                        emailField.after('<div class="error text-red-400 text-xs mt-1">Email is already registered</div>');
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Registration Failed',
                            text: errorMessage,
                        });
                    }
                },
                complete: () => {
                    $('#registerBtn').prop('disabled', false).text('Register');
                }
            });
        }
    </script>
</body>
</html>
